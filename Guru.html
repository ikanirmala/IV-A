<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link id="favicon" rel="icon" type="image/x-icon" href="https://lh3.googleusercontent.com/d/16rll5zsRdwTbR3nF_NmPKwY51tg4tnOn">
    <title>GURU - Dashboard Panel</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4A90E2; --primary-dark: #357ABD; --secondary-color: #7F8C8D; 
            --success-color: #2ECC71; --danger-color: #E74C3C; --warning-color: #F1C40F; 
            --info-color: #3498DB; --light-color: #FDFEFE; --dark-color: #2C3E50; 
            --background-color: #F0F2F5; --text-color: #2C3E50; --card-bg-color: #FFFFFF; 
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --border-radius: 16px; --border-color: #E2E8F0;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; font-size: 14px; }
        
        /* Login Styles */
        #login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #4A90E2, #8E44AD); }
        .login-card { background: white; padding: 40px; border-radius: 20px; width: 100%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); text-align: center; transform: scale(0.95); opacity: 0; animation: fadeUp 0.5s forwards; }

        /* Layout */
        #dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background-color: white; color: var(--dark-color); display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; box-shadow: 2px 0 10px rgba(0,0,0,0.05); transition: 0.3s; }
        .sidebar-header { padding: 30px 20px; text-align: center; border-bottom: 1px solid var(--background-color); }
        .sidebar-header h3 { font-weight: 700; color: var(--primary-color); letter-spacing: 1px; }
        .sidebar-nav { flex-grow: 1; padding: 20px 0; overflow-y: auto; perspective: 1000px; }
        
        .sidebar-nav .nav-link { 
            display: flex; align-items: center; gap: 12px; padding: 12px 25px; 
            color: var(--secondary-color); text-decoration: none; 
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
            font-weight: 500; font-size: 14px; border-left: 4px solid transparent; 
            cursor: pointer; transform-origin: left center;
        }
        
        .sidebar-nav .nav-link:hover, .sidebar-nav .nav-link.active { 
            background: linear-gradient(90deg, #F0F7FF 0%, #FFFFFF 100%); 
            color: var(--primary-color); 
            border-left-color: var(--primary-color);
            transform: scale(1.05) translateX(10px); 
            box-shadow: 5px 5px 15px rgba(74, 144, 226, 0.15); 
            z-index: 10;
        }

        .sidebar-nav .nav-link:hover i {
            animation: wiggle 0.5s ease-in-out;
            color: var(--primary-color);
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg) scale(1.2); }
            75% { transform: rotate(15deg) scale(1.2); }
        }
        
        /* Submenu Styling */
        .sidebar-submenu { overflow: hidden; transition: max-height 0.3s ease-out; background: #F8FAFC; margin: 0 15px; border-radius: 8px; }
        .sidebar-submenu .nav-link { padding-left: 45px; font-size: 13px; border-left: none; }
        .sidebar-submenu .nav-link:hover, .sidebar-submenu .nav-link.active-sub { color: var(--primary-color); background: #E0F2FE; border-radius: 8px; font-weight: 600; transform: scale(1.02) translateX(5px); }
        .arrow-icon { transition: transform 0.3s; font-size: 10px; margin-left: auto; }
        .arrow-icon.rotate { transform: rotate(90deg); }
        .main-content { flex-grow: 1; margin-left: 260px; padding: 30px; width: calc(100% - 260px); }

        /* Generic Components */
        .card { background: white; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); margin-bottom: 25px; border: 1px solid white; transition: 0.3s ease; }
        .card:hover { box-shadow: var(--shadow-md); }
        .card h3 { font-size: 18px; font-weight: 600; color: var(--dark-color); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .card h3 i { color: var(--primary-color); }

        /* Buttons */
        .btn, .action-btn { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; font-family: inherit; font-size: 13px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, #4A90E2, #357ABD); color: white; }
        .btn-success { background: linear-gradient(135deg, #2ECC71, #27AE60); color: white; }
        .btn-danger { background: linear-gradient(135deg, #E74C3C, #C0392B); color: white; }
        .btn-info { background: linear-gradient(135deg, #3498DB, #2980B9); color: white; }
        .action-btn.edit { background-color: #EBF5FB; color: var(--info-color); box-shadow: none; }
        .action-btn.edit:hover { background-color: var(--info-color); color: white; }
        .action-btn.delete { background-color: #FDEDEC; color: var(--danger-color); box-shadow: none; }
        .action-btn.delete:hover { background-color: var(--danger-color); color: white; }
        .action-btn.download { background-color: #EAFAF1; color: var(--success-color); box-shadow: none; }

        /* Tables */
        .table-wrapper { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border-color); margin-top: 20px; max-height: 65vh; background: white; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 16px 20px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; font-size: 13px; }
        th { background: #F8FAFC; font-weight: 600; color: #64748B; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 2; border-bottom: 2px solid var(--border-color); }
        tbody tr:hover { background-color: #F8FAFC; }
        
        /* Form Styling Enhanced */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        .form-group { margin-bottom: 20px; position: relative; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 13px; color: #64748B; transition: 0.3s; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border-radius: 10px; border: 1px solid #CBD5E1; font-family: inherit; font-size: 14px; background: #F8FAFC; transition: 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { background: white; border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1); }
        .full-width { grid-column: 1 / -1; }

        /* NEW STYLES FOR SETTINGS & SCHOOL DATA */
        .settings-section-title { font-size: 14px; font-weight: 700; color: var(--secondary-color); text-transform: uppercase; letter-spacing: 1px; margin: 30px 0 15px; border-bottom: 2px solid #F1F5F9; padding-bottom: 10px; grid-column: 1 / -1; }

        .ibadah-card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; animation: fadeUp 0.5s ease; }
        .ibadah-card { background: white; border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; transition: 0.3s; position: relative; overflow: hidden; }
        .ibadah-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--primary-color); }
        .ibadah-card.active { background: #F0F7FF; border-color: var(--primary-color); }
        .ibadah-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .ibadah-title { font-weight: 600; font-size: 15px; display: flex; align-items: center; gap: 8px; }
        .ibadah-icon { width: 32px; height: 32px; background: #E0F2FE; color: var(--primary-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        
        /* Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #CBD5E1; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        .predikat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 10px; }
        .predikat-card { padding: 20px; border-radius: 12px; text-align: center; color: white; position: relative; overflow: hidden; }
        .predikat-card.taat { background: linear-gradient(135deg, #2ECC71, #27AE60); box-shadow: 0 8px 16px rgba(46, 204, 113, 0.2); }
        .predikat-card.terbiasa { background: linear-gradient(135deg, #F1C40F, #F39C12); box-shadow: 0 8px 16px rgba(241, 196, 15, 0.2); }
        .predikat-card.kurang { background: linear-gradient(135deg, #E74C3C, #C0392B); box-shadow: 0 8px 16px rgba(231, 76, 60, 0.2); }
        .predikat-icon { font-size: 24px; margin-bottom: 10px; opacity: 0.8; }
        .predikat-input { background: rgba(255,255,255,0.2) !important; border: 1px solid rgba(255,255,255,0.3) !important; color: white !important; text-align: center; font-weight: 600; }
        .predikat-input::placeholder { color: rgba(255,255,255,0.7); }

        /* School Data Enhancements */
        .school-info-grid { display: grid; grid-template-columns: 200px 1fr; gap: 30px; align-items: start; }
        .school-logo-preview-container { text-align: center; padding: 20px; background: #F8FAFC; border-radius: 16px; border: 2px dashed #CBD5E1; }
        .school-logo-preview { width: 120px; height: 120px; object-fit: contain; margin-bottom: 15px; border-radius: 50%; box-shadow: var(--shadow-md); background: white; padding: 10px; }
        .school-form-fields { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }

        /* Animations */
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-up { animation: fadeUp 0.5s ease forwards; }

        /* Page Mgmt */
        .page { display: none; }
        .page.active { display: block; animation: fadeUp 0.4s ease; }

        /* Charts Styles (NEW) */
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-top: 20px; }
        .chart-wrapper { position: relative; height: 350px; background: white; padding: 20px; border-radius: 12px; border: 1px solid #E2E8F0; box-shadow: var(--shadow-sm); }
        .chart-title { font-size: 16px; font-weight: 600; color: var(--dark-color); margin-bottom: 15px; border-bottom: 1px solid #F1F5F9; padding-bottom: 10px; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar { width: 0; overflow: hidden; }
            .main-content { margin-left: 0; width: 100%; padding: 20px; }
            .school-info-grid { grid-template-columns: 1fr; }
            .predikat-grid { grid-template-columns: 1fr; }
            .school-form-fields { grid-template-columns: 1fr; }
            .chart-grid { grid-template-columns: 1fr; }
        }

        /* Other styles */
        .controls-wrapper { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 20px; align-items: flex-start; margin-bottom: 25px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: fadeUp 0.3s ease; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #F1F5F9; }
        .modal-header h3 { font-size: 20px; color: var(--dark-color); }
        
        #edit-form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; padding: 10px 0; }
        .checklist-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .checklist-option { display: flex; align-items: center; gap: 10px; background-color: #F8FAFC; padding: 12px; border-radius: 10px; border: 1px solid transparent; cursor: pointer; transition: 0.2s; }
        .checklist-option:hover { border-color: var(--primary-color); background: white; }
        .checklist-option input { width: 1.2em; height: 1.2em; accent-color: var(--primary-color); }
        .lainnya-text-input { display: none; width: 100%; margin-top: 10px; }

        .gallery-preview { width: 100%; height: 160px; object-fit: cover; border-radius: 12px; border: 1px solid #E2E8F0; margin-bottom: 10px; transition: 0.3s; }
        .gallery-preview:hover { transform: scale(1.02); }
        
        .search-container { position: relative; margin-bottom: 0; }
        .search-container i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94A3B8; }
        .search-container input { padding-left: 45px !important; width: 250px; background: white; border-color: #E2E8F0; }
    </style>
</head>
<body>

    <div id="login-container">
        <div class="login-card">
            <div style="font-size: 40px; color: var(--primary-color); margin-bottom: 10px;"><i class="fas fa-graduation-cap"></i></div>
            <h2 style="color: var(--dark-color); margin-bottom: 5px;">Login Guru</h2>
            <p style="margin: 0 0 30px; color: #94A3B8; font-size: 13px;">Panel Manajemen Kelas & Laporan 7KAIH</p>
            <form id="loginForm">
                <div class="form-group"><input type="text" id="username" placeholder="Username" required></div>
                <div class="form-group"><input type="password" id="password" placeholder="Password" required></div>
                <button type="submit" id="loginButton" class="btn btn-primary" style="width: 100%; justify-content: center; padding: 15px; font-size: 15px; margin-top: 10px;">Masuk </button>
                <a href="./" class="btn btn-danger" style="width: 50%; justify-content: center; padding: 15px; font-size: 15px; margin-top: 10px;"><i class="fas fa-home"></i></a>

            </form>
        </div>
    </div>

    <div id="dashboard-container" style="display: none;">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-school"></i> IV-A</h3>
            </div>
            <nav class="sidebar-nav">
                <a href="./" class="nav-link"><i class="fas fa-home"></i> Home</a>
                
                <!-- DROPDOWN MENU START -->
                <div class="nav-item-dropdown">
                    <a href="javascript:void(0)" class="nav-link" id="nav-laporan-parent" onclick="toggleSidebarDropdown(this)">
                        <i class="fas fa-file-invoice"></i> Laporan Siswa <i class="fas fa-chevron-right arrow-icon"></i>
                    </a>
                    <div class="sidebar-submenu" id="submenu-laporan" style="display: none;">
                        <a href="javascript:void(0)" class="nav-link sub-link" onclick="openLaporanSub('grafik', this)"><i class="fas fa-chart-bar"></i> Grafik</a>
                        <a href="javascript:void(0)" class="nav-link sub-link" onclick="openLaporanSub('data', this)"><i class="fas fa-table"></i> Data</a>
                        <a href="javascript:void(0)" class="nav-link sub-link" onclick="openLaporanSub('nilai', this)"><i class="fas fa-star-half-alt"></i> Nilai</a>
                        <a href="javascript:void(0)" class="nav-link sub-link" onclick="openLaporanSub('rekap', this)"><i class="fas fa-chart-pie"></i> Rekap</a>
                        <a href="javascript:void(0)" class="nav-link sub-link" onclick="openLaporanSub('predikat', this)"><i class="fas fa-award"></i> Predikat</a>
                        <a href="javascript:void(0)" class="nav-link sub-link" onclick="openLaporanSub('analisis', this)"><i class="fas fa-search-plus"></i> Analisis Rinci</a>
                    </div>
                </div>
                <!-- DROPDOWN MENU END -->

                <a href="#" class="nav-link" data-page="page-siswa"><i class="fas fa-user-graduate"></i> Data Siswa</a>
                <a href="#" class="nav-link" data-page="page-sekolah"><i class="fas fa-school"></i> Data Sekolah</a>
                <a href="#" class="nav-link" data-page="page-pengaturan"><i class="fas fa-cogs"></i> Pengaturan 7KAIH</a>
                <a href="#" class="nav-link" data-page="page-galeri"><i class="fas fa-images"></i> Galeri & YouTube</a>
                <a href="#" class="nav-link" data-page="page-kelas"><i class="fas fa-info-circle"></i> Info Visual Kelas</a>
                <a href="#" class="nav-link" data-page="page-aplikasi"><i class="fas fa-database"></i> Data Aplikasi</a>
            </nav>
            <div style="padding: 20px;">
                <button id="logoutButtonSide" class="btn btn-danger" style="width: 100%; justify-content: center;"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 id="page-title" style="font-size: 24px; font-weight: 700; color: var(--dark-color);">Laporan Siswa</h2>
                    <p style="font-size: 13px; color: #94A3B8;">Selamat datang kembali di panel manajemen.</p>
                </div>
                <div id="guru-badge" style="background: white; padding: 8px 20px; border-radius: 50px; box-shadow: var(--shadow-sm); font-size: 13px; font-weight: 600; color: var(--primary-color); display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-user-circle" style="font-size: 20px;"></i> <span id="guru-name-display">Guru</span>
                </div>
            </div>

            <!-- Page Laporan -->
            <section id="page-laporan" class="page active">
                <!-- CHART SECTION: GRAFIK UTAMA -->
                <div id="grafik-view" style="display:none; margin-bottom: 25px;">
                    <div class="card">
                        <div class="chart-title"><i class="fas fa-chart-bar"></i> Grafik 7 Kebiasaan Anak Indonesia Hebat (Kelas Ini)</div>
                        <div style="position: relative; height: 400px; width: 100%;">
                            <canvas id="guruGlobalChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- CHART SECTION: ANALISIS RINCI -->
                <div id="analisis-view" style="display:none; margin-bottom: 25px;">
                    <!-- Ibadah Section -->
                    <div class="settings-section-title">Analisis Ibadah</div>
                    <div id="analisis-ibadah-rinci-container" class="chart-grid"></div>

                    <!-- Waktu Section -->
                    <div class="settings-section-title" style="margin-top: 30px;">Analisis Waktu</div>
                    <div class="chart-grid">
                        <div class="chart-wrapper">
                            <div class="chart-title">Bangun Pagi</div>
                            <canvas id="guruBangunChart"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-title">Tidur Cepat</div>
                            <canvas id="guruTidurChart"></canvas>
                        </div>
                    </div>

                    <!-- Kegiatan Section -->
                    <div class="settings-section-title" style="margin-top: 30px;">Analisis Kegiatan</div>
                    <div class="chart-grid">
                        <div class="chart-wrapper">
                            <div class="chart-title">Olahraga</div>
                            <canvas id="guruOlahragaChart"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-title">Bermasyarakat</div>
                            <canvas id="guruMasyarakatChart"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-title">Belajar</div>
                            <canvas id="guruBelajarChart"></canvas>
                        </div>
                    </div>

                    <!-- Makanan Section -->
                    <div class="settings-section-title" style="margin-top: 30px;">Analisis Makanan Sehat</div>
                    <div class="card">
                        <div class="chart-title">Detail Konsumsi Makanan Sehat</div>
                        <div style="position: relative; height: 350px; width: 100%;">
                            <canvas id="guruMakananChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- TABLE SECTION -->
                <div id="laporan-table-container" class="card">
                    <div class="controls-wrapper">
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center; width: 100%;">
                            <div style="display: flex; align-items: center; gap: 10px; background: #F8FAFC; padding: 5px 10px; border-radius: 10px; border: 1px solid #E2E8F0;">
                                <i class="far fa-calendar-alt" style="color: #94A3B8;"></i>
                                <input type="date" id="rep-startDate" style="border: none; background: transparent; padding: 5px; font-size: 13px;">
                                <span style="color: #94A3B8;">-</span>
                                <input type="date" id="rep-endDate" style="border: none; background: transparent; padding: 5px; font-size: 13px;">
                                <button class="btn btn-primary" style="padding: 5px 15px; font-size: 12px;" onclick="applyDateFilter()">Filter</button>
                            </div>
                            <div class="search-container" style="flex-grow: 1;">
                                <i class="fas fa-search"></i>
                                <input type="text" id="laporanSearch" onkeyup="filterLaporanTable()" placeholder="Cari Siswa..." style="width: 100%;">
                            </div>
                            <button id="btnDownloadRekap" class="action-btn download" onclick="downloadRekapPDF()" style="display: none;"><i class="fas fa-file-pdf"></i> PDF</button>
                        </div>
                    </div>

                    <div class="table-wrapper">
                        <table id="laporanTable">
                            <thead></thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Page Siswa -->
            <section id="page-siswa" class="page">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h3><i class="fas fa-users"></i> Data Siswa Kelas <span id="span-kelas"></span></h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="openModal('siswaExcelModal')"><i class="fas fa-file-excel"></i> Import Excel</button>
                            <button class="btn btn-primary" onclick="openSiswaModal()"><i class="fas fa-plus"></i> Tambah Manual</button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="siswaTable">
                            <thead><tr><th>Foto</th><th>Nama Lengkap</th><th>No. Induk</th><th>Agama</th><th>Aksi</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Page Sekolah (UPDATED: Added Social Media & Contact Inputs) -->
            <section id="page-sekolah" class="page">
                <div class="card animate-up">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3><i class="fas fa-university"></i> Identitas Sekolah</h3>
                        <button class="btn btn-success" onclick="saveSekolahData()"><i class="fas fa-save"></i> Simpan Perubahan</button>
                    </div>
                    <form id="sekolahForm" class="school-info-grid"></form>
                </div>
                
                <div class="card animate-up" style="animation-delay: 0.1s;">
                    <h3><i class="fas fa-bullhorn"></i> Visi, Misi & Sambutan Guru</h3>
                    <form id="infoForm" class="form-grid"></form>
                </div>
            </section>

            <!-- Page Pengaturan -->
            <section id="page-pengaturan" class="page">
                <div class="card animate-up">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h3><i class="fas fa-sliders-h"></i> Pengaturan Sistem 7KAIH</h3>
                        <button class="btn btn-success" onclick="saveGlobalSettings()"><i class="fas fa-save"></i> Simpan Pengaturan</button>
                    </div>
                    
                    <div id="pengaturan-container"></div>
                </div>
            </section>

            <!-- Page Galeri -->
            <section id="page-galeri" class="page">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h3><i class="fas fa-images"></i> Galeri Kegiatan (Maks. 10)</h3>
                        <button class="btn btn-success" onclick="saveGaleri()"><i class="fas fa-save"></i> Simpan Galeri</button>
                    </div>
                    <div id="galeri-list" class="form-grid" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));"></div>
                    
                    <div class="settings-section-title" style="margin-top: 40px;"><i class="fab fa-youtube"></i> Video YouTube Highlight</div>
                    <div id="youtube-list" class="form-grid"></div>
                </div>
            </section>

            <!-- Page Kelas -->
            <section id="page-kelas" class="page">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h3><i class="fas fa-chalkboard"></i> Visualisasi Informasi Kelas</h3>
                        <button class="btn btn-success" onclick="saveKelasVisual()"><i class="fas fa-save"></i> Simpan Info</button>
                    </div>
                    <form id="kelasVisualForm" class="form-grid"></form>
                </div>
            </section>

            <!-- Page Aplikasi -->
            <section id="page-aplikasi" class="page">
                <div class="card">
                    <h3><i class="fas fa-user-edit"></i> Edit Profil & Akun</h3>
                    <div class="form-grid">
                        <div class="form-group"><label>Nama Guru</label><input type="text" id="profile-nama"></div>
                        <div class="form-group"><label>Username</label><input type="text" id="profile-username"></div>
                        <div class="form-group"><label>Password</label><input type="text" id="profile-password"></div>
                        <div class="form-group"><label>Kelas</label><input type="text" placeholder="Pastikan Nama Kelas Sama dengan Kelas Yang ada di Data Siswa" id="profile-kelas"></div>
                    </div>
                    <button class="btn btn-success" onclick="updateGuruProfile()" style="margin-top: 20px;"><i class="fas fa-save"></i> Perbarui Profil</button>
                </div>

                <div class="form-grid">
                    <div class="card">
                        <h3><i class="fas fa-cloud-download-alt"></i> Backup Data</h3>
                        <p style="font-size: 13px; color: #64748B; margin: 10px 0 20px;">Unduh seluruh data siswa, laporan, dan pengaturan dalam format JSON untuk cadangan keamanan.</p>
                        <button class="btn btn-primary" onclick="backupSystem()"><i class="fas fa-download"></i> Unduh Backup</button>
                    </div>
                    <div class="card" style="border-color: #FECACA;">
                        <h3 style="color: var(--danger-color);"><i class="fas fa-exclamation-triangle"></i> Reset Laporan</h3>
                        <p style="font-size: 13px; color: #64748B; margin: 10px 0 20px;">Menghapus semua data laporan siswa di kelas ini. Tindakan ini <strong>tidak dapat dibatalkan</strong>.</p>
                        <button class="btn btn-danger" onclick="resetLaporan()"><i class="fas fa-trash"></i> Reset Data Laporan</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="msgModal" class="modal"><div class="modal-content" style="max-width: 400px; text-align: center;"><div style="margin-bottom: 15px; font-size: 50px; color: var(--info-color);"><i class="fas fa-info-circle"></i></div><h3 id="msgTitle" style="margin-bottom: 10px;">Pemberitahuan</h3><p id="msgText" style="color: #64748B; margin-bottom: 25px;"></p><div id="msgModalButtons" style="display: flex; justify-content: center; gap: 10px;"><button class="btn btn-primary" onclick="closeModal('msgModal')">Mengerti</button></div></div></div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Laporan Siswa</h3>
                <span style="cursor:pointer; font-size: 24px; color: #94A3B8;" onclick="closeModal('editModal')">×</span>
            </div>
            <form id="editForm">
                <input type="hidden" id="editDocId">
                <div id="edit-form-grid"></div>
                <div style="text-align: right; margin-top: 25px; border-top: 1px solid #F1F5F9; padding-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')" style="margin-right: 10px;">Batal</button>
                    <button type="button" class="btn btn-success" onclick="saveChanges()"><i class="fas fa-save"></i> Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="siswaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="siswaModalTitle">Data Siswa</h3><span style="cursor:pointer; font-size: 24px; color: #94A3B8;" onclick="closeModal('siswaModal')">×</span></div>
            <form id="siswaForm">
                <input type="hidden" id="siswaId">
                <div class="form-grid">
                    <div class="form-group"><label>Nama Lengkap</label><input type="text" id="siswaNama" required placeholder="Contoh: Budi Santoso"></div>
                    <div class="form-group"><label>No. Induk</label><input type="text" id="siswaInduk" required placeholder="NIS/NISN"></div>
                    <div class="form-group"><label>Agama</label><select id="siswaAgama"><option>Islam</option><option>Kristen</option><option>Katolik</option><option>Hindu</option><option>Buddha</option><option>Konghucu</option></select></div>
                    <div class="form-group"><label>Foto Siswa</label><div style="display:flex;gap:10px"><input type="text" id="siswaFoto" placeholder="URL Foto"><button type="button" class="btn btn-info" onclick="document.getElementById('f-siswa').click()"><i class="fas fa-folder-open"></i></button><input type="file" id="f-siswa" style="display:none" onchange="handleFileUpload(this, 'siswaFoto')"></div></div>
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top: 25px; width: 100%; justify-content: center;">Simpan Data Siswa</button>
            </form>
        </div>
    </div>

    <div id="siswaExcelModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header"><h3>Import Data via Excel</h3><span style="cursor:pointer; font-size: 24px;" onclick="closeModal('siswaExcelModal')">×</span></div>
            <div style="padding: 10px 0;">
                <p style="font-size: 13px; color: #64748B; margin-bottom: 20px;">Unduh format, isi data siswa, lalu upload kembali.</p>
                <button class="btn btn-success" onclick="downloadSiswaExcel()" style="width: 100%; margin-bottom: 20px;"><i class="fas fa-download"></i> Download Format Excel</button>
                <div style="border: 2px dashed #CBD5E1; padding: 30px; text-align: center; border-radius: 12px; background: #F8FAFC;">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 40px; color: var(--primary-color); margin-bottom: 15px;"></i>
                    <input type="file" id="excelInput" accept=".xlsx, .xls" style="display: block; width: 100%; margin-top: 10px;">
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="uploadSiswaExcel()">Upload & Proses Data</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://ztcdcxqbffobonlubiga.supabase.co";
        const SUPABASE_KEY = "sb_publishable_Tlt7BdyANH_U1j_wVXLcnw_ltkzm-Bb";
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwc9cOPEvpl1dVb-qIcHEaokHTUXtT10fyn1X8f8Cga-gHkQcb4DpzmQ75sVK84BtqKAQ/exec";
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentUser = null;
        let globalSettings = {};
        let fullData = [];
        let rawLaporanData = []; // Store raw object data for charts
        let filteredData = [];
        let activeLaporanView = 'data';
        let chartInstances = {}; // Store chart instances

        // --- AUTH ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const btn = document.getElementById('loginButton');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memuat...';
            btn.disabled = true;

            const { data, error } = await supabaseClient.from('users').select('*').eq('username', u).single();
            
            btn.innerHTML = originalText;
            btn.disabled = false;

            if (error || !data || data.password !== p) return showModal("Username atau Password salah.", "Gagal Login");
            if (data.role !== 'Guru' && data.role !== 'Admin') return showModal("Anda tidak memiliki akses sebagai Guru.", "Akses Ditolak");
            
            currentUser = data;
            sessionStorage.setItem('guruUser', JSON.stringify(data));
            initDashboard();
        });

        async function initDashboard() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'flex';
            document.getElementById('guru-name-display').textContent = `${currentUser.nama} (${currentUser.kelas})`;
            document.querySelector('.sidebar-header h3').innerHTML = `<i class="fas fa-school"></i> ${currentUser.kelas}`;
            document.getElementById('span-kelas').textContent = currentUser.kelas;
            
            await loadGlobalSettings();
            
            // Populate profile form
            populateProfileForm();
            
            // Default Open Laporan > Grafik (Updated per request to start showing data, but default sub menu logic below)
            openLaporanSub('grafik', document.querySelectorAll('.sub-link')[0]); 
            toggleSidebarDropdown(document.getElementById('nav-laporan-parent'));
        }

        async function loadGlobalSettings() {
            const { data } = await supabaseClient.from('pengaturan').select('data').eq('key', 'global').single();
            if (data) globalSettings = data.data;
            if (globalSettings.infoSekolah && globalSettings.infoSekolah.logo) {
                document.getElementById('favicon').href = globalSettings.infoSekolah.logo;
            }
        }

        // --- NAVIGATION & DROPDOWN ---
        
        function toggleSidebarDropdown(element) {
            const submenu = element.nextElementSibling;
            const arrow = element.querySelector('.arrow-icon');
            
            if (submenu.style.display === 'none' || submenu.style.display === '') {
                submenu.style.display = 'block';
                arrow.classList.add('rotate');
                element.classList.add('active'); 
            } else {
                submenu.style.display = 'none';
                arrow.classList.remove('rotate');
                element.classList.remove('active');
            }
        }

        function openLaporanSub(view, element) {
            switchPage('page-laporan');
            
            document.querySelectorAll('.sub-link').forEach(el => el.classList.remove('active-sub'));
            if(element) element.classList.add('active-sub');
            
            switchLaporanView(view);
        }

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => { 
                if(link.dataset.page) {
                    e.preventDefault(); 
                    switchPage(link.dataset.page); 
                }
            });
        });

        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => {
                // Don't remove active from parent dropdown or sublinks here immediately, handled separately
                if(l.dataset.page) l.classList.remove('active');
            });
            
            document.getElementById(pageId).classList.add('active');
            
            const link = document.querySelector(`[data-page="${pageId}"]`);
            if(link) link.classList.add('active');
            
            // Special handling for Laporan Data Load
            if (pageId === 'page-laporan' && fullData.length === 0) loadLaporanData();
            if (pageId === 'page-siswa') loadSiswaData();
            if (pageId === 'page-sekolah') renderSekolahForms();
            if (pageId === 'page-pengaturan') renderPengaturanForms();
            if (pageId === 'page-galeri') renderGaleriForms();
            if (pageId === 'page-kelas') renderKelasVisualForm();
        }

        // --- OTHER FUNCTIONS ---
        
        async function loadLaporanData() {
            const tbody = document.querySelector("#laporanTable tbody");
            tbody.innerHTML = '<tr><td colspan="20" style="text-align:center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Memuat Data...</td></tr>';
            try {
                const { data: laporanData, error } = await supabaseClient.from('laporan').select('*').eq('kelas', currentUser.kelas).order('created_at', { ascending: false });
                if (error) throw error;
                
                // Map snake_case to camelCase for Charts Logic (consistency with Admin logic)
                rawLaporanData = laporanData.map(d => ({
                    ...d,
                    namaSiswa: d.nama_siswa,
                    tanggalKegiatan: d.tanggal_kegiatan,
                    bangunPagi: d.bangun_pagi,
                    tidurCepat: d.tidur_cepat,
                    rincianOlahraga: d.rincian_olahraga,
                    tempatBelajar: d.tempat_belajar,
                    materiBelajar: d.materi_belajar,
                    kegiatanMasyarakat: d.kegiatan_masyarakat,
                    makananKarbo: d.makanan_karbo,
                    makananSayur: d.makanan_sayur,
                    makananSusu: d.makanan_susu,
                    makananLauk: d.makanan_lauk,
                    makananAir: d.makanan_air
                }));

                const headers = ["ID", "Nama Siswa", "Tanggal", "I1", "I2", "I3", "I4", "I5", "I6", "I7", "Pagi", "Tidur", "Olahraga", "Belajar", "Materi", "Masyarakat", "Karbo", "Sayur", "Susu", "Protein", "Air"];
                const dataArray = [headers];
                laporanData.forEach(d => {
                    dataArray.push([d.id, d.nama_siswa, d.tanggal_kegiatan, d.ibadah1||'', d.ibadah2||'', d.ibadah3||'', d.ibadah4||'', d.ibadah5||'', d.ibadah6||'', d.ibadah7||'', d.bangun_pagi?d.bangun_pagi.substring(0,5):'', d.tidur_cepat?d.tidur_cepat.substring(0,5):'', d.rincian_olahraga||'', d.tempat_belajar||'', d.materi_belajar||'', d.kegiatan_masyarakat||'', d.makanan_karbo?'Ya':'', d.makanan_sayur?'Ya':'', d.makanan_susu?'Ya':'', d.makanan_lauk?'Ya':'', d.makanan_air?'Ya':'']);
                });
                fullData = dataArray;
                applyDateFilter();
            } catch (err) { tbody.innerHTML = `<tr><td colspan="20" style="color:red; text-align:center;">Gagal memuat: ${err.message}</td></tr>`; }
        }

        function applyDateFilter() {
            const startDate = document.getElementById('rep-startDate').value;
            const endDate = document.getElementById('rep-endDate').value;
            if (!startDate || !endDate) filteredData = [...fullData];
            else {
                const start = new Date(startDate); const end = new Date(endDate);
                const dataRows = fullData.slice(1);
                const result = dataRows.filter(row => { const rowDate = new Date(row[2]); return rowDate >= start && rowDate <= end; });
                filteredData = [fullData[0], ...result];
            }
            populateLaporanTable(activeLaporanView);
            
            // Re-render charts if view is chart
            if (activeLaporanView === 'grafik') renderGuruGlobalChart();
            if (activeLaporanView === 'analisis') renderGuruAnalisis();
        }

        function switchLaporanView(view) {
            activeLaporanView = view;
            
            // Toggle PDF Button Logic
            const btnPdf = document.getElementById('btnDownloadRekap'); 
            if(btnPdf) btnPdf.style.display = (view === 'rekap' || view === 'predikat') ? 'inline-flex' : 'none';

            // VISIBILITY TOGGLE (Chart vs Table)
            const tableContainer = document.getElementById('laporan-table-container');
            const grafikContainer = document.getElementById('grafik-view');
            const analisisContainer = document.getElementById('analisis-view');

            tableContainer.style.display = 'none';
            grafikContainer.style.display = 'none';
            analisisContainer.style.display = 'none';

            if (view === 'grafik') {
                grafikContainer.style.display = 'block';
                renderGuruGlobalChart();
            } else if (view === 'analisis') {
                analisisContainer.style.display = 'block';
                renderGuruAnalisis();
            } else {
                tableContainer.style.display = 'block';
                populateLaporanTable(view);
            }
        }

        // --- CHART FUNCTIONS (ADAPTED FROM ADMIN) ---

        function processGuruClassData() {
            const { ibadahSettings = [], waktu = {}, predikat = {} } = globalSettings;
            const ibadahThreshold = ibadahSettings.filter(s => s).length;
            const bbp = waktu.bangunPagi || '05:00';
            const btc = waktu.tidurCepat || '21:00';
            
            // Filter raw data based on date if filter applied (Basic implementation uses full rawData for now, but can be improved)
            // For now using all raw data for charts as date filter logic for objects needs to be mirrored
            let processedData = rawLaporanData;
            const startDate = document.getElementById('rep-startDate').value;
            const endDate = document.getElementById('rep-endDate').value;
            
            if (startDate && endDate) {
                const start = new Date(startDate); const end = new Date(endDate);
                processedData = rawLaporanData.filter(d => {
                    const rowDate = new Date(d.tanggalKegiatan);
                    return rowDate >= start && rowDate <= end;
                });
            }

            const studentRekap = {};
            processedData.forEach(d => {
                if (!d.namaSiswa) return;
                const key = d.namaSiswa; // Only one class, use name as key
                if (!studentRekap[key]) studentRekap[key] = { totalHari: 0, beribadah: 0, tidurCepat: 0, bangunPagi: 0, olahraga: 0, belajar: 0, bermasyarakat: 0, makanBergizi: 0 };
                
                const data = studentRekap[key]; 
                data.totalHari++; 
                
                let ibadahPoint = 0;
                for(let j=0; j<7; j++) { if(ibadahSettings[j] && String(d[`ibadah${j+1}`]||'').trim()) ibadahPoint++; }
                if(ibadahThreshold > 0 && ibadahPoint >= ibadahThreshold) data.beribadah++;
                
                if (d.bangunPagi && d.bangunPagi <= bbp) data.bangunPagi++; 
                if (d.tidurCepat && d.tidurCepat <= btc) data.tidurCepat++;
                if (String(d.rincianOlahraga || '').trim()) data.olahraga++; 
                if (String(d.tempatBelajar || '').trim() && String(d.materiBelajar || '').trim()) data.belajar++;
                if (String(d.kegiatanMasyarakat || '').trim()) data.bermasyarakat++; 
                if (d.makananKarbo && d.makananSayur && d.makananSusu && d.makananLauk && d.makananAir) data.makanBergizi++;
            });

            // Aggregate Class Data (Taat, Terbiasa, Kurang)
            const rekap = {
                beribadah: {}, tidurCepat: {}, bangunPagi: {}, olahraga: {}, belajar: {}, bermasyarakat: {}, makanBergizi: {}
            };
            const keys = ["beribadah", "tidurCepat", "bangunPagi", "olahraga", "belajar", "bermasyarakat", "makanBergizi"];
            
            Object.values(studentRekap).forEach(data => {
                keys.forEach(catKey => {
                    let p_text = predikat.kurangText || 'Perlu Peningkatan';
                    if (data.totalHari > 0) { 
                        const prob = (data[catKey] / data.totalHari) * 100;
                        if (prob >= (predikat.taatValue || 85)) { p_text = predikat.taatText || 'Anak Hebat'; }
                        else if (prob >= (predikat.terbiasaValue || 70)) { p_text = predikat.terbiasaText || 'Terbiasa'; }
                    }
                    rekap[catKey][p_text] = (rekap[catKey][p_text] || 0) + 1;
                });
            });

            return { rekap, processedData };
        }

        function renderGuruGlobalChart() {
            const { rekap } = processGuruClassData();
            const { predikat = {} } = globalSettings; 
            const t = predikat.taatText || 'Anak Hebat'; 
            const b = predikat.terbiasaText || 'Terbiasa'; 
            const k = predikat.kurangText || 'Perlu Peningkatan';
            
            const labels = ["Beribadah", "Tidur Cepat", "Bangun Pagi", "Olahraga", "Belajar", "Bermasyarakat", "Makan Bergizi"];
            const keys = ["beribadah", "tidurCepat", "bangunPagi", "olahraga", "belajar", "bermasyarakat", "makanBergizi"];
            const tData = [], bData = [], kData = [];
            
            keys.forEach(key => {
                tData.push(rekap[key][t] || 0);
                bData.push(rekap[key][b] || 0);
                kData.push(rekap[key][k] || 0);
            });

            const ctx = document.getElementById('guruGlobalChart').getContext('2d');
            if (chartInstances.global) chartInstances.global.destroy();
            
            chartInstances.global = new Chart(ctx, { 
                type: 'bar', 
                data: { 
                    labels: labels, 
                    datasets: [
                        { label: t, data: tData, backgroundColor: 'rgba(22, 163, 74, 0.7)' }, 
                        { label: b, data: bData, backgroundColor: 'rgba(245, 158, 11, 0.7)' }, 
                        { label: k, data: kData, backgroundColor: 'rgba(239, 68, 68, 0.7)' }
                    ] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
                    plugins: { tooltip: { mode: 'index' } }
                } 
            });
        }

        function renderGuruAnalisis() {
            const { processedData: laporanData } = processGuruClassData();
            const { ibadahSettings, ibadahOptions, waktu = {} } = globalSettings;
            
            // 1. Ibadah Breakdown
            const container = document.getElementById('analisis-ibadah-rinci-container');
            container.innerHTML = '';

            for (let i = 1; i <= 7; i++) {
                if (!ibadahSettings[i - 1]) continue;
                const ibadahKey = `ibadah${i}`; const options = ibadahOptions[ibadahKey] || [];
                const counts = {}; options.forEach(opt => counts[opt] = 0); let tidakMelaksanakan = 0;
                
                laporanData.forEach(l => { const v = l[ibadahKey]; if (v && options.includes(v)) { counts[v]++; } else { tidakMelaksanakan++; } });
                
                const chartLabels = []; const chartData = []; 
                const backgroundColors = ['rgba(75, 192, 192, 0.7)','rgba(255, 159, 64, 0.7)','rgba(255, 205, 86, 0.7)','rgba(54, 162, 235, 0.7)','rgba(153, 102, 255, 0.7)','rgba(255, 99, 132, 0.7)'];
                
                for (const option in counts) { if (counts[option] > 0) { chartLabels.push(option); chartData.push(counts[option]); } }
                if (tidakMelaksanakan > 0) { chartLabels.push('Tidak Melaksanakan'); chartData.push(tidakMelaksanakan); }
                
                if (chartData.length === 0) continue;
                
                const wrapper = document.createElement('div'); wrapper.className = 'chart-wrapper'; 
                wrapper.innerHTML = `<div class="chart-title">Detail Ibadah ${i}</div>`;
                const canvas = document.createElement('canvas'); wrapper.appendChild(canvas); container.appendChild(wrapper);
                
                new Chart(canvas.getContext('2d'), { 
                    type: 'doughnut', 
                    data: { labels: chartLabels, datasets: [{ data: chartData, backgroundColor: backgroundColors, borderWidth: 1 }] }, 
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } } 
                });
            }

            // 2. Bangun Pagi (Pie)
            const bbp = waktu.bangunPagi || '05:00';
            let bpt = 0;
            laporanData.forEach(l => { if (l.bangunPagi && l.bangunPagi <= bbp) bpt++; });
            renderChart('guruBangunChart', 'pie', ['Tepat Waktu', 'Terlambat'], [bpt, laporanData.length - bpt], ['#2ECC71', '#E74C3C']);

            // 3. Tidur Cepat (Pie)
            const btc = waktu.tidurCepat || '21:00';
            let tct = 0;
            laporanData.forEach(l => { if (l.tidurCepat && l.tidurCepat <= btc) tct++; });
            renderChart('guruTidurChart', 'pie', ['Tepat Waktu', 'Terlambat'], [tct, laporanData.length - tct], ['#3498DB', '#E74C3C']);

            // 4. Olahraga (Donut)
            let olg = 0;
            laporanData.forEach(l => { if (l.rincianOlahraga && l.rincianOlahraga.trim()) olg++; });
            renderChart('guruOlahragaChart', 'doughnut', ['Melakukan', 'Tidak'], [olg, laporanData.length - olg], ['#F1C40F', '#95A5A6']);

            // 5. Bermasyarakat (Donut)
            let masy = 0;
            laporanData.forEach(l => { if (l.kegiatanMasyarakat && l.kegiatanMasyarakat.trim()) masy++; });
            renderChart('guruMasyarakatChart', 'doughnut', ['Melakukan', 'Tidak'], [masy, laporanData.length - masy], ['#9B59B6', '#95A5A6']);

            // 6. Belajar (Donut)
            let bel = 0;
            laporanData.forEach(l => { if ((l.tempatBelajar && l.tempatBelajar.trim()) || (l.materiBelajar && l.materiBelajar.trim())) bel++; });
            renderChart('guruBelajarChart', 'doughnut', ['Belajar', 'Tidak'], [bel, laporanData.length - bel], ['#34495E', '#95A5A6']);

            // 7. Makanan Sehat Detail (Horizontal Bar)
            let mCounts = { Karbo: 0, Sayur: 0, Susu: 0, Lauk: 0, Air: 0 };
            laporanData.forEach(l => {
                if (l.makananKarbo) mCounts.Karbo++;
                if (l.makananSayur) mCounts.Sayur++;
                if (l.makananSusu) mCounts.Susu++;
                if (l.makananLauk) mCounts.Lauk++;
                if (l.makananAir) mCounts.Air++;
            });

            const ctxMakan = document.getElementById('guruMakananChart').getContext('2d');
            if (chartInstances['guruMakananChart']) chartInstances['guruMakananChart'].destroy();
            chartInstances['guruMakananChart'] = new Chart(ctxMakan, {
                type: 'bar',
                data: {
                    labels: Object.keys(mCounts),
                    datasets: [{
                        label: 'Jumlah Siswa',
                        data: Object.values(mCounts),
                        backgroundColor: ['#e67e22', '#2ecc71', '#ecf0f1', '#e74c3c', '#3498db'],
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', 
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function renderChart(id, type, labels, data, colors) {
            const ctx = document.getElementById(id).getContext('2d');
            if (chartInstances[id]) chartInstances[id].destroy();
            chartInstances[id] = new Chart(ctx, {
                type: type,
                data: { labels: labels, datasets: [{ label: 'Jumlah', data: data, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }


        function populateLaporanTable(viewType) {
            const thead = document.querySelector("#laporanTable thead");
            const tbody = document.querySelector("#laporanTable tbody");
            const tfoot = document.querySelector("#laporanTable tfoot");
            thead.innerHTML = ""; tbody.innerHTML = ""; tfoot.innerHTML = "";
            if (filteredData.length <= 1) { tbody.innerHTML = `<tr><td colspan="20" style="text-align:center; padding:30px; color:#94A3B8;">Tidak ada data laporan ditemukan.</td></tr>`; return; }
            
            const dataToDisplay = filteredData.slice(1);
            const { ibadahSettings=[], predikat={}, waktu={} } = globalSettings;
            const bPagi = waktu.bangunPagi||'05:00'; const bTidur = waktu.tidurCepat||'21:00'; const ibTh = ibadahSettings.filter(s=>s).length||1;

            if (viewType === 'data') {
                const hRow = document.createElement('tr'); filteredData[0].forEach(h => { const th=document.createElement('th'); th.textContent=h; hRow.appendChild(th); });
                hRow.appendChild(document.createElement('th')).textContent="Aksi"; thead.appendChild(hRow);
                dataToDisplay.forEach(row => {
                    const tr = document.createElement('tr'); row.forEach(c => tr.insertCell().textContent=c);
                    tr.insertCell().innerHTML = `<button class="action-btn edit" onclick="openEditModal('${row[0]}')"><i class="fas fa-edit"></i></button> <button class="action-btn delete" onclick="deleteLaporanData('${row[0]}')"><i class="fas fa-trash"></i></button>`;
                    tbody.appendChild(tr);
                });
            } else if (viewType === 'nilai') {
                const h = ["Nama Siswa", "Tanggal", "I1", "I2", "I3", "I4", "I5", "I6", "I7", "Pagi", "Tidur", "Olga", "Belajar", "Sosial", "Makan"];
                const hRow = document.createElement('tr'); h.forEach(t => hRow.appendChild(document.createElement('th')).textContent = t); thead.appendChild(hRow);
                const sums = new Array(h.length-2).fill(0);
                dataToDisplay.forEach(r => {
                    const tr = document.createElement('tr'); tr.insertCell().textContent=r[1]; tr.insertCell().textContent=r[2];
                    let idx=0;
                    for(let j=3; j<=9; j++) { const v=String(r[j]).trim()?1:0; tr.insertCell().innerHTML=v?`<span style="color:var(--success-color)">●</span>`:`<span style="color:#E2E8F0">●</span>`; if(v) sums[idx]++; idx++; }
                    const p=(r[10]&&r[10]<=bPagi)?1:0; tr.insertCell().innerHTML=p?`<span style="color:var(--success-color)">●</span>`:`<span style="color:#E2E8F0">●</span>`; if(p) sums[idx]++; idx++;
                    const t=(r[11]&&r[11]<=bTidur)?1:0; tr.insertCell().innerHTML=t?`<span style="color:var(--success-color)">●</span>`:`<span style="color:#E2E8F0">●</span>`; if(t) sums[idx]++; idx++;
                    const o=String(r[12]).trim()?1:0; tr.insertCell().innerHTML=o?`<span style="color:var(--success-color)">●</span>`:`<span style="color:#E2E8F0">●</span>`; if(o) sums[idx]++; idx++;
                    const b=(String(r[13]).trim()&&String(r[14]).trim())?1:0; tr.insertCell().innerHTML=b?`<span style="color:var(--success-color)">●</span>`:`<span style="color:#E2E8F0">●</span>`; if(b) sums[idx]++; idx++;
                    const s=String(r[15]).trim()?1:0; tr.insertCell().innerHTML=s?`<span style="color:var(--success-color)">●</span>`:`<span style="color:#E2E8F0">●</span>`; if(s) sums[idx]++; idx++;
                    const m=r.slice(16,21).every(v=>v==='Ya')?1:0; tr.insertCell().innerHTML=m?`<span style="color:var(--success-color)">●</span>`:`<span style="color:#E2E8F0">●</span>`; if(m) sums[idx]++;
                    tbody.appendChild(tr);
                });
                const fRow = tfoot.insertRow(); fRow.insertCell().colSpan=2; fRow.insertCell().innerHTML="<strong>Rata-rata %</strong>";
                sums.forEach(s => fRow.insertCell().innerHTML=`<strong>${((s/dataToDisplay.length)*100).toFixed(0)}%</strong>`);
            } else {
                const h = ["Nama Siswa", "Beribadah", "Tidur Cepat", "Bangun Pagi", "Olahraga", "Belajar", "Bermasyarakat", "Makan Sehat"]; if(viewType==='predikat') h.push("Aksi");
                const hRow = document.createElement('tr'); h.forEach(t => hRow.appendChild(document.createElement('th')).textContent = t); thead.appendChild(hRow);
                const rekap = {};
                dataToDisplay.forEach(r => {
                    const n = r[1]; if(!rekap[n]) rekap[n]={tot:0,ib:0,td:0,bg:0,ol:0,bl:0,ms:0,mk:0}; rekap[n].tot++;
                    let ibP=0; for(let j=0; j<7; j++) if(ibadahSettings[j] && String(r[j+3]).trim()) ibP++;
                    if(ibP>=ibTh) rekap[n].ib++; if(r[11]&&r[11]<=bTidur) rekap[n].td++; if(r[10]&&r[10]<=bPagi) rekap[n].bg++;
                    if(String(r[12]).trim()) rekap[n].ol++; if(String(r[13]).trim()&&String(r[14]).trim()) rekap[n].bl++; if(String(r[15]).trim()) rekap[n].ms++;
                    if(r.slice(16,21).every(v=>v==='Ya')) rekap[n].mk++;
                });
                for(const n in rekap) {
                    const d = rekap[n]; const tr = document.createElement('tr'); tr.insertCell().textContent = n;
                    const keys = ['ib','td','bg','ol','bl','ms','mk']; const pdfD={};
                    keys.forEach(k => {
                        const cell = tr.insertCell();
                        if(viewType==='rekap') cell.textContent = `${d[k]}/${d.tot}`;
                        else {
                            let pd = predikat.kurangText||'Kurang'; const p=(d[k]/d.tot)*100;
                            if(p>(predikat.taatValue||90)) pd = predikat.taatText||'Taat';
                            else if(p>(predikat.terbiasaValue||50)) pd = predikat.terbiasaText||'Terbiasa';
                            const color = pd===(predikat.taatText||'Taat')?'var(--success-color)':(pd===(predikat.terbiasaText||'Terbiasa')?'var(--warning-color)':'var(--danger-color)');
                            cell.innerHTML = `<span style="color:${color}; font-weight:600;">${pd}</span>`; pdfD[k]=pd;
                        }
                    });
                    if(viewType==='predikat') {
                        const safeName = n.replace(/'/g, "\\'");
                        tr.insertCell().innerHTML = `<button class="action-btn download" onclick='downloadPDF("${safeName}", ${JSON.stringify(pdfD)})'><i class="fas fa-file-pdf"></i></button>`;
                    }
                    tbody.appendChild(tr);
                }
            }
        }

        function filterLaporanTable() {
            const q = document.getElementById('laporanSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#laporanTable tbody tr');
            const idx = (activeLaporanView === 'data' || activeLaporanView === 'nilai') ? 1 : 0;
            rows.forEach(r => { const c = r.getElementsByTagName('td')[idx]; if(c) r.style.display = c.textContent.toLowerCase().includes(q) ? "" : "none"; });
        }

        async function openEditModal(docId) {
            try {
                const { data, error } = await supabaseClient.from('laporan').select('*').eq('id', docId).single();
                if (error || !data) return showModal('Data tidak ditemukan.', 'Error');
                
                const grid = document.getElementById('edit-form-grid'); grid.innerHTML = ''; document.getElementById('editDocId').value = docId;
                grid.innerHTML += `<div class="form-group"><label>Nama Siswa</label><input type="text" value="${data.nama_siswa}" readonly style="background:#F1F5F9;"></div><div class="form-group"><label>Tanggal</label><input type="date" id="edit-tgl" value="${data.tanggal_kegiatan}"></div>`;

                let ibHtml = '<div class="form-group full-width"><label style="font-weight:600; color:var(--primary-color);">Ibadah</label><div class="checklist-container">';
                const ibO = globalSettings.ibadahOptions || {}; const ibS = globalSettings.ibadahSettings || [];
                for (let i = 1; i <= 7; i++) {
                    if (ibS[i-1]) {
                        let opts = `<option value="">- Belum Mengisi -</option>`;
                        (ibO[`ibadah${i}`] || []).forEach(o => { opts += `<option value="${o}" ${data[`ibadah${i}`] === o ? 'selected' : ''}>${o}</option>`; });
                        ibHtml += `<div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Ibadah ${i}</label><select id="edit-ib${i}" style="font-size:13px">${opts}</select></div>`;
                    }
                }
                grid.innerHTML += ibHtml + '</div></div>';
                grid.innerHTML += `<div class="form-group"><label>Jam Bangun</label><input type="time" id="edit-pagi" value="${data.bangun_pagi?data.bangun_pagi.substring(0,5):''}"></div><div class="form-group"><label>Jam Tidur</label><input type="time" id="edit-tidur" value="${data.tidur_cepat?data.tidur_cepat.substring(0,5):''}"></div>`;
                
                const olgOpts = ["Senam", "Bersepeda", "Lari", "Renang", "Bulu Tangkis", "Sepak Bola", "Karate/Silat", "Melakukan peregangan sebelum mandi"];
                grid.innerHTML += createChecklistGroup('olg', 'Olahraga', olgOpts, data.rincian_olahraga);
                const masyOpts = ["Bermain bersama teman", "Membantu orang tua di rumah", "Belajar kelompok bersama teman", "Membersihkan lingkungan rumah", "Menolong teman"];
                grid.innerHTML += createChecklistGroup('masy', 'Bermasyarakat', masyOpts, data.kegiatan_masyarakat);
                grid.innerHTML += `<div class="form-group"><label>Tempat Belajar</label><input type="text" id="edit-tmpt" value="${data.tempat_belajar||''}"></div><div class="form-group full-width"><label>Materi</label><textarea id="edit-mat" rows="2">${data.materi_belajar||''}</textarea></div>`;
                const mkn = [['makanan_karbo','Karbo','mKarbo'],['makanan_sayur','Sayur','mSayur'],['makanan_susu','Susu','mSusu'],['makanan_lauk','Protein','mProtein'],['makanan_air','Air','mAir']];
                let mknHtml = '<div class="form-group full-width"><label style="font-weight:600; color:var(--primary-color);">Makanan Sehat</label><div class="checklist-container">';
                mkn.forEach(m => { mknHtml += `<label class="checklist-option"><input type="checkbox" id="edit-${m[2]}" ${data[m[0]]?'checked':''}> <span>${m[1]}</span></label>`; });
                grid.innerHTML += mknHtml + '</div></div>';

                openModal('editModal');
            } catch (e) { showModal('Gagal memuat data edit.', 'Error'); }
        }

        function createChecklistGroup(prefix, title, opts, saved) {
            const savedArr = saved ? saved.split(',').map(s => s.trim()) : [];
            let lValue = savedArr.find(v => !opts.includes(v)) || '';
            let html = `<div class="form-group full-width"><label style="font-weight:600; color:var(--primary-color);">${title}</label><div class="checklist-container">`;
            opts.forEach((o, i) => { html += `<label class="checklist-option"><input type="checkbox" name="edit-${prefix}" value="${o}" ${savedArr.includes(o)?'checked':''}> <span>${o}</span></label>`; });
            html += `<label class="checklist-option"><input type="checkbox" id="edit-${prefix}-lCheck" name="edit-${prefix}" value="Lainnya" ${lValue?'checked':''} onchange="document.getElementById('edit-${prefix}-lText').style.display=this.checked?'block':'none'"> <span>Lainnya</span></label></div><input type="text" id="edit-${prefix}-lText" class="lainnya-text-input" value="${lValue}" style="display:${lValue?'block':'none'}" placeholder="Sebutkan..."></div>`;
            return html;
        }

        async function saveChanges() {
            const id = document.getElementById('editDocId').value;
            const up = {
                tanggal_kegiatan: document.getElementById('edit-tgl').value,
                bangun_pagi: document.getElementById('edit-pagi').value,
                tidur_cepat: document.getElementById('edit-tidur').value,
                tempat_belajar: document.getElementById('edit-tmpt').value,
                materi_belajar: document.getElementById('edit-mat').value,
                makanan_karbo: document.getElementById('edit-mKarbo').checked,
                makanan_sayur: document.getElementById('edit-mSayur').checked,
                makanan_susu: document.getElementById('edit-mSusu').checked,
                makanan_lauk: document.getElementById('edit-mProtein').checked,
                makanan_air: document.getElementById('edit-mAir').checked,
                rincian_olahraga: getChecklistData('edit-olg', 'edit-olg-lText', 'edit-olg-lCheck'),
                kegiatan_masyarakat: getChecklistData('edit-masy', 'edit-masy-lText', 'edit-masy-lCheck')
            };
            for(let i=1;i<=7;i++) { const el = document.getElementById(`edit-ib${i}`); if(el) up[`ibadah${i}`] = el.value; }
            
            const { error } = await supabaseClient.from('laporan').update(up).eq('id', id);
            if(!error) { showModal('Data berhasil diperbarui!', 'Sukses'); closeModal('editModal'); loadLaporanData(); }
            else showModal('Gagal menyimpan.', 'Error');
        }

        function getChecklistData(name, textId, checkId) {
            let res = [];
            document.querySelectorAll(`input[name="${name}"]:checked`).forEach(c => { if(c.value !== 'Lainnya') res.push(c.value); });
            const lText = document.getElementById(textId).value.trim();
            if(document.getElementById(checkId).checked && lText) res.push(lText);
            return res.join(', ');
        }

        function deleteLaporanData(id) {
            showConfirmModal('Hapus laporan ini permanen?', async () => {
                await supabaseClient.from('laporan').delete().eq('id', id);
                loadLaporanData();
            });
        }

        // --- PDF DOWNLOAD ---
        function downloadPDF(name, predicates) {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const info = globalSettings.infoSekolah || {};
            
            doc.setFontSize(16); doc.text(info.namaSekolah || "Sekolah", 105, 20, {align:"center"});
            doc.setFontSize(10); doc.text("Laporan Pembiasaan Harian 7KAIH", 105, 26, {align:"center"});
            doc.setLineWidth(0.5); doc.line(20, 32, 190, 32); 
            
            doc.setFontSize(12); doc.text(`Nama: ${name}`, 20, 50); doc.text(`Kelas: ${currentUser.kelas}`, 20, 57);
            const body = []; const map = {ib:"Beribadah", td:"Tidur Cepat", bg:"Bangun Pagi", ol:"Olahraga", bl:"Belajar", ms:"Bermasyarakat", mk:"Makan Bergizi"};
            for(let k in predicates) body.push([map[k], predicates[k]]);
            doc.autoTable({ head:[['Kategori','Predikat']], body:body, startY:70, theme:'grid', headStyles: { fillColor: [74, 144, 226] } });
            let finalY = doc.lastAutoTable.finalY + 20; if (finalY > 250) { doc.addPage(); finalY = 20; }
            const today = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            const place = info.namaTempat || 'Tempat';
            
            doc.setFontSize(10);
            doc.text('Mengetahui,', 20, finalY + 7); doc.text('Kepala Sekolah', 20, finalY + 14);
            doc.text(info.namaKepsek || '', 20, finalY + 37); doc.text(`NIP. ${info.nipKepsek || '-'}`, 20, finalY + 44);

            doc.text(`${place}, ${today}`, 190, finalY, { align: 'right' });
            doc.text(`Guru Kelas ${currentUser.kelas}`, 190, finalY + 7, { align: 'right' });
            doc.text(currentUser.nama || '', 190, finalY + 37, { align: 'right' });
            doc.text(`NIP. ${currentUser.nip || '-'}`, 190, finalY + 44, { align: 'right' });

            doc.save(`Laporan_${name}.pdf`);
        }

        function downloadRekapPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape' });
            const info = globalSettings.infoSekolah || {};
            const startDate = document.getElementById('rep-startDate').value; const endDate = document.getElementById('rep-endDate').value;
            let periode = (startDate && endDate) ? `${startDate} s/d ${endDate}` : 'Keseluruhan';

            doc.setFontSize(16); doc.setFont("helvetica", "bold"); doc.text(info.namaSekolah || "Sekolah", 148, 15, { align: "center" });
            doc.setFontSize(12); doc.setFont("helvetica", "normal"); doc.text(`Rekap Kelas ${currentUser.kelas} - ${activeLaporanView.toUpperCase()} (${periode})`, 148, 22, { align: "center" });

            const tbl = document.getElementById('laporanTable').cloneNode(true);
            const headers = tbl.querySelectorAll('thead th'); if (headers.length>0 && headers[headers.length-1].textContent.trim()==='Aksi') { headers[headers.length-1].remove(); tbl.querySelectorAll('tbody tr').forEach(r => { const c=r.querySelectorAll('td'); if(c.length>0) c[c.length-1].remove(); }); }

            doc.autoTable({ html: tbl, startY: 35, theme: 'grid', headStyles: { fillColor: [74, 144, 226] } });
            
            let finalY = doc.lastAutoTable.finalY + 20; if (finalY > 160) { doc.addPage(); finalY = 20; }
            const today = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

            doc.setFontSize(10);
            doc.text('Mengetahui,', 20, finalY + 7); doc.text('Kepala Sekolah', 20, finalY + 14);
            doc.text(info.namaKepsek || '', 20, finalY + 37); doc.text(`NIP. ${info.nipKepsek || '-'}`, 20, finalY + 44);

            doc.text(`${info.namaTempat || 'Tempat'}, ${today}`, 280, finalY, { align: 'right' });
            doc.text(`Guru Kelas ${currentUser.kelas}`, 280, finalY + 7, { align: 'right' });
            doc.text(currentUser.nama || '', 280, finalY + 37, { align: 'right' });
            doc.text(`NIP. ${currentUser.nip || '-'}`, 280, finalY + 44, { align: 'right' });

            doc.save(`Rekap_${currentUser.kelas}.pdf`);
        }

        // --- GALERI & KELAS ---
        function renderGaleriForms() {
            // UPDATED: Now supports 10 items
            const gal = globalSettings.infoSekolah?.galeri || Array(10).fill("");
            const yt = globalSettings.infoSekolah?.youtubeLinks || ["","",""];
            let gHtml = '';
            for(let i=1; i<=10; i++) {
                gHtml += `<div class="card" style="padding:15px; margin:0; text-align:center;"><img src="${gal[i-1]||'https://placehold.co/200?text=Foto'}" id="prev-gal-${i}" class="gallery-preview"><div style="display:flex;gap:5px"><input type="text" id="gal-url-${i}" value="${gal[i-1]||''}" onchange="document.getElementById('prev-gal-${i}').src=this.value" placeholder="URL Gambar"><button class="btn btn-info" onclick="document.getElementById('f-gal-${i}').click()"><i class="fas fa-upload"></i></button><input type="file" id="f-gal-${i}" style="display:none" onchange="handleFileUpload(this, 'gal-url-${i}')"></div></div>`;
            }
            document.getElementById('galeri-list').innerHTML = gHtml;
            document.getElementById('youtube-list').innerHTML = yt.map((u, idx) => `<div class="form-group"><label>Link YouTube ${idx+1}</label><input type="text" id="yt-url-${idx}" value="${u}" placeholder="https://youtube.com/..."></div>`).join('');
        }

        async function saveGaleri() {
            // UPDATED: Now saves 10 items
            const gal = []; 
            for(let i=1; i<=10; i++) { 
                gal.push(document.getElementById(`gal-url-${i}`).value); 
            }
            const yt = []; 
            for(let i=0; i<3; i++) {
                yt.push(document.getElementById(`yt-url-${i}`).value);
            }
            
            if(!globalSettings.infoSekolah) globalSettings.infoSekolah = {};
            globalSettings.infoSekolah.galeri = gal; 
            globalSettings.infoSekolah.youtubeLinks = yt;
            
            await supabaseClient.from('pengaturan').upsert({ key:'global', data: globalSettings });
            showModal("Media Galeri & YouTube Berhasil Disimpan!", "Sukses");
        }

        // --- RENDER KELAS VISUAL FORM (DENGAN FORM PENGUMUMAN) ---
        function renderKelasVisualForm() {
            const ik = globalSettings.infoSekolah?.infoKelas || {};
            const pengumumanData = globalSettings.infoSekolah?.pengumuman || {};
            const form = document.getElementById('kelasVisualForm');
            
            let pengumumanFormHtml = `<div class="settings-section-title" style="margin-bottom: 20px;"><i class="fas fa-bullhorn"></i> Kelola Pengumuman Sekolah</div>`;
            
            for(let i=1; i<=3; i++) {
                const p = pengumumanData[`pengumuman${i}`] || {};
                pengumumanFormHtml += `
                <div class="card" style="border: 1px solid #E2E8F0; padding: 20px; margin-bottom: 20px; background-color: #F8FAFC;">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Pengumuman ${i}</h3>
                    <div class="form-grid" style="grid-template-columns: 1fr;">
                        <div class="form-group">
                            <label>Judul Pengumuman</label>
                            <input type="text" id="pengumuman-judul-${i}" value="${p[`pengumuman${i}Judul`] || ''}" placeholder="Contoh: Libur Nasional">
                        </div>
                        <div class="form-group">
                            <label>URL Gambar (Opsional)</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="pengumuman-gambar-${i}" value="${p[`pengumuman${i}Gambar`] || ''}" placeholder="URL Gambar">
                                <button type="button" class="btn btn-info" onclick="document.getElementById('f-pengumuman-${i}').click()"><i class="fas fa-folder-open"></i></button>
                                <input type="file" id="f-pengumuman-${i}" style="display:none" onchange="handleFileUpload(this, 'pengumuman-gambar-${i}')">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>URL Dokumen/Link (Opsional)</label>
                            <input type="text" id="pengumuman-dokumen-${i}" value="${p[`pengumuman${i}Dokumen`] || ''}" placeholder="Link G-Drive/Website">
                        </div>
                        <div class="form-group full-width">
                            <label>Isi Pengumuman</label>
                            <textarea id="pengumuman-text-${i}" rows="3" placeholder="Tulis isi pengumuman disini...">${p[`pengumuman${i}Text`] || ''}</textarea>
                        </div>
                    </div>
                </div>`;
            }

            let visualKelasHtml = `
                <div class="settings-section-title" style="margin: 30px 0 20px;"><i class="fas fa-chalkboard"></i> Info Visual Kelas</div>
                <div class="form-group full-width"><label>Jadwal Pelajaran (URL Gambar)</label><div style="display:flex;gap:10px"><input type="text" id="iv-jadwal" value="${ik.jadwalPelajaran||''}"><button type="button" class="btn btn-info" onclick="document.getElementById('f-iv-j').click()"><i class="fas fa-folder-open"></i></button><input type="file" id="f-iv-j" style="display:none" onchange="handleFileUpload(this, 'iv-jadwal')"></div></div>
                <div class="form-group full-width"><label>Struktur Organisasi (URL Gambar)</label><div style="display:flex;gap:10px"><input type="text" id="iv-struktur" value="${ik.strukturOrganisasi||''}"><button type="button" class="btn btn-info" onclick="document.getElementById('f-iv-s').click()"><i class="fas fa-folder-open"></i></button><input type="file" id="f-iv-s" style="display:none" onchange="handleFileUpload(this, 'iv-struktur')"></div></div>
                <div class="form-group full-width"><label>Kesepakatan Kelas (URL Gambar)</label><div style="display:flex;gap:10px"><input type="text" id="iv-kesepakatan" value="${ik.kesepakatanKelas||''}"><button type="button" class="btn btn-info" onclick="document.getElementById('f-iv-k').click()"><i class="fas fa-folder-open"></i></button><input type="file" id="f-iv-k" style="display:none" onchange="handleFileUpload(this, 'iv-kesepakatan')"></div></div>
            `;

            form.innerHTML = pengumumanFormHtml + visualKelasHtml;
        }

        async function saveKelasVisual() {
            if(!globalSettings.infoSekolah) globalSettings.infoSekolah = {};
            
            globalSettings.infoSekolah.infoKelas = { 
                jadwalPelajaran: document.getElementById('iv-jadwal').value, 
                strukturOrganisasi: document.getElementById('iv-struktur').value, 
                kesepakatanKelas: document.getElementById('iv-kesepakatan').value 
            };

            if (!globalSettings.infoSekolah.pengumuman) globalSettings.infoSekolah.pengumuman = {};
            
            for(let i=1; i<=3; i++) {
                const judul = document.getElementById(`pengumuman-judul-${i}`).value;
                const gambar = document.getElementById(`pengumuman-gambar-${i}`).value;
                const dokumen = document.getElementById(`pengumuman-dokumen-${i}`).value;
                const text = document.getElementById(`pengumuman-text-${i}`).value;
                
                globalSettings.infoSekolah.pengumuman[`pengumuman${i}`] = {
                    [`pengumuman${i}Judul`]: judul,
                    [`pengumuman${i}Gambar`]: gambar,
                    [`pengumuman${i}Dokumen`]: dokumen,
                    [`pengumuman${i}Text`]: text
                };
            }

            await supabaseClient.from('pengaturan').upsert({ key:'global', data: globalSettings });
            showModal("Info Kelas & Pengumuman Berhasil Disimpan!", "Sukses");
        }

        // --- SISWA EXCEL & UTILS ---
        async function loadSiswaData() {
            const tbody = document.querySelector("#siswaTable tbody"); tbody.innerHTML = '';
            const { data } = await supabaseClient.from('siswa').select('*').eq('kelas', currentUser.kelas);
            (data||[]).forEach(s => {
                tbody.innerHTML += `<tr><td><img src="${s.foto||'https://placehold.co/30'}" style="width:35px;height:35px;border-radius:50%;object-fit:cover;border:1px solid #ddd"></td><td>${s.nama}</td><td>${s.nomor_induk}</td><td>${s.agama}</td><td><button class="action-btn edit" onclick="openSiswaModal('${s.id}')"><i class="fas fa-edit"></i></button> <button class="action-btn delete" onclick="deleteSiswa('${s.id}')"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }
        
        function downloadSiswaExcel() { const ws = XLSX.utils.json_to_sheet([{nama:"Nama Siswa", nomorInduk:"12345", agama:"Islam", foto:""}]); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Siswa"); XLSX.writeFile(wb, "Format_Siswa.xlsx"); }
        
        async function uploadSiswaExcel() {
            const f = document.getElementById('excelInput').files[0]; if(!f) return showModal("Pilih file dulu.");
            const r = new FileReader();
            r.onload = async (e) => {
                const wb = XLSX.read(e.target.result, {type:'binary'}); const d = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                for(const row of d) { await supabaseClient.from('siswa').insert([{nama:row.nama, nomor_induk:row.nomorInduk, agama:row.agama, foto:row.foto, kelas:currentUser.kelas}]); }
                showModal("Import Berhasil!", "Sukses"); closeModal('siswaExcelModal'); loadSiswaData();
            }; r.readAsBinaryString(f);
        }

        async function openSiswaModal(id = null) {
            document.getElementById('siswaForm').reset(); document.getElementById('siswaId').value = id || '';
            if (id) { const { data } = await supabaseClient.from('siswa').select('*').eq('id', id).single(); if (data) { document.getElementById('siswaNama').value = data.nama; document.getElementById('siswaInduk').value = data.nomor_induk; document.getElementById('siswaAgama').value = data.agama; document.getElementById('siswaFoto').value = data.foto||''; } }
            openModal('siswaModal');
        }

        document.getElementById('siswaForm').addEventListener('submit', async (e) => {
            e.preventDefault(); const id = document.getElementById('siswaId').value;
            const p = { nama: document.getElementById('siswaNama').value, nomor_induk: document.getElementById('siswaInduk').value, agama: document.getElementById('siswaAgama').value, foto: document.getElementById('siswaFoto').value, kelas: currentUser.kelas };
            const { error } = id ? await supabaseClient.from('siswa').update(p).eq('id', id) : await supabaseClient.from('siswa').insert([p]);
            if (!error) { closeModal('siswaModal'); loadSiswaData(); showModal("Data Siswa Tersimpan!", "Sukses"); }
        });

        async function handleFileUpload(input, targetId) {
            const file = input.files[0]; if(!file) return;
            const btn = input.previousElementSibling; const old = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result.split(',')[1];
                try {
                    const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ fileName: file.name, mimeType: file.type, fileData: base64 }) });
                    const r = await res.json();
                    if(r.status === 'success') { document.getElementById(targetId).value = r.url; showModal("File Berhasil Diupload!", "Sukses"); }
                    else throw new Error("Gagal upload");
                } catch(err) { showModal("Upload Gagal.", "Error"); }
                btn.disabled = false; btn.innerHTML = old;
            };
            reader.readAsDataURL(file);
        }

        // --- PROFILE EDIT ---
        function populateProfileForm() {
            if(!currentUser) return;
            document.getElementById('profile-nama').value = currentUser.nama;
            document.getElementById('profile-username').value = currentUser.username;
            document.getElementById('profile-password').value = currentUser.password;
            document.getElementById('profile-kelas').value = currentUser.kelas;
        }

        async function updateGuruProfile() {
            const nama = document.getElementById('profile-nama').value;
            const username = document.getElementById('profile-username').value;
            const password = document.getElementById('profile-password').value;
            const kelas = document.getElementById('profile-kelas').value;

            if(!nama || !username || !password || !kelas) return showModal("Semua kolom harus diisi!");

            try {
                const { error } = await supabaseClient.from('users').update({ nama, username, password, kelas }).eq('id', currentUser.id);
                if(error) throw error;
                
                // Update Local Data
                currentUser.nama = nama; currentUser.username = username; currentUser.password = password; currentUser.kelas = kelas;
                sessionStorage.setItem('guruUser', JSON.stringify(currentUser));
                
                // Refresh UI Elements
                document.getElementById('guru-name-display').textContent = `${currentUser.nama} (${currentUser.kelas})`;
                document.querySelector('.sidebar-header h3').innerHTML = `<i class="fas fa-school"></i> ${currentUser.kelas}`;
                document.getElementById('span-kelas').textContent = currentUser.kelas;

                showModal("Profil berhasil diperbarui!", "Sukses");
            } catch(e) {
                showModal("Gagal memperbarui profil: " + e.message, "Error");
            }
        }

        async function backupSystem() {
            const { data: siswaData } = await supabaseClient.from('siswa').select('*').eq('kelas', currentUser.kelas);
            const backup = { settings: globalSettings, laporan: fullData, siswa: siswaData };
            const blob = new Blob([JSON.stringify(backup)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_${currentUser.kelas}.json`; a.click();
        }

        async function resetLaporan() { if(confirm("Hapus semua laporan di kelas ini?")) { await supabaseClient.from('laporan').delete().eq('kelas', currentUser.kelas); loadLaporanData(); } }
        async function deleteSiswa(id) { if(confirm("Hapus siswa ini?")) { await supabaseClient.from('siswa').delete().eq('id', id); loadSiswaData(); } }

        function showModal(text, title = 'Pemberitahuan') { document.getElementById('msgTitle').textContent = title; document.getElementById('msgText').textContent = text; openModal('msgModal'); }
        function showConfirmModal(text, onConfirm) { 
            document.getElementById('msgTitle').textContent = 'Konfirmasi'; document.getElementById('msgText').textContent = text;
            const btnWrap = document.getElementById('msgModalButtons'); btnWrap.innerHTML = '';
            const cBtn = document.createElement('button'); cBtn.className = 'btn btn-danger'; cBtn.textContent = 'Ya, Lanjutkan'; cBtn.onclick = () => { closeModal('msgModal'); onConfirm(); };
            const aBtn = document.createElement('button'); aBtn.className = 'btn btn-secondary'; aBtn.textContent = 'Batal'; aBtn.onclick = () => closeModal('msgModal');
            btnWrap.appendChild(aBtn); btnWrap.appendChild(cBtn); openModal('msgModal'); 
        }
        function openModal(id) { document.getElementById(id).classList.add('show'); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }

        document.getElementById('logoutButtonSide').addEventListener('click', () => { sessionStorage.clear(); window.location.reload(); });
        window.onload = () => { const stored = sessionStorage.getItem('guruUser'); if (stored) { currentUser = JSON.parse(stored); initDashboard(); } };
    </script>
</body>
</html>
